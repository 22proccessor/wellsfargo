var oofStates={"hi":"Hawaii","ky":"Kentucky","la":"Louisiana","me":"Maine","ma":"Massachusetts","mo":"Missouri","nh":"New Hampshire","ok":"Oklahoma","ri":"Rhode Island","vt":"Vermont","wv":"West Virginia","in":"Indiana","oh":"Ohio","mi":"Michigan"};function untaintAndParse(str){if(str.substr(0,100).search(/for *\(;;/)==-1){Utility.ajaxLog({"message":"Expected JSON result but got: "+str.substr(0,100)+"..."});return str;}try{str=str.replace(/^\s*for *\(;;\) *;?\s*/,"");str=str.replace(/^\s*\/\*\s*\w+%\s+\{/,"{").replace(/\}\s+%\w+\s*\*\/\s*$/,"}");return jQuery.parseJSON(str);}catch(err){Utility.ajaxLog(err);}}function CityChooser(){this.id=$("#cityChooser");this.cities=[];this.popularCities=[];this.theAlphaFilterNode=$("#alphaFilter").html();this.showAllCitiesLink=$("#showAllCitiesLink");this.cityByAlphabet=$("#cityByAlphabet");this.closer=("#closer");this.heading=("#cityChooserHeading");if(WF.Page.lang=="es"){this.errorMsg="<div class='errorMsg'><img src='/assets/images/locator/icn_error_16x16.gif' width='16'  height='16' alt='Error'> <span style='float:left'>Lo sentimos. En este momento no podemos listar las ciudades que tienen ATM/sucursales en este estado. Vuelva a intentar m&aacute;s tarde o ingrese la informaci&oacute;n en el campo de b&uacute;squeda para encontrar un ATM/sucursal.</span><div class='clearAll'></div></div>";}else{this.errorMsg="<div class='errorMsg'><img src='/assets/images/locator/icn_error_16x16.gif' width='16'  height='16' alt='Error'> <span style='float:left'>We're sorry. We are temporarily unable to list the cities that have locations in this state. Please try again later or enter your information in the search field to find a location.</span><div class='clearAll'></div></div>";}this.showChooser=function(){$(this.id).show();$(this.heading).focus();$(this.showAllCitiesLink).hide();$(this.cityByAlphabet).show();};this.init=function(){var closer=this.closer,chooserId=this.id,chooser=this;chooser.addAria(chooser.id);$(closer).click(function(event){event.preventDefault();$(chooserId).hide();});$(chooser.showAllCitiesLink).click(function(e){e.preventDefault();chooser.getCityList(chooser.chosenState);$(this).hide();$(chooser.cityByAlphabet).show();$("#alphaFilter li").removeClass("letterFilterHighlight");});};}CityChooser.prototype.getCityList=function(chosenState,fullStateName){$("#allCities").html("");if($("#popularCities").children().length>0){$("#popularCities").children().remove();}this.cities=[];this.popularCities=[];this.chosenState=chosenState;var _this=this;if(typeof(oofStates[chosenState])!=="string"){$.ajax({type:"GET",url:"/locator/as/getCities/"+chosenState,data:"",success:function(data){try{$("#popularCityCol").show();$(".heading").show();$("#alphaFilterSection").show();$("#overflowContainer").removeClass("errorContainer");$("#allCities").removeClass("citiesSingleCol");data=untaintAndParse(data);data.allCities.sort();for(var i=0;i<data.allCities.length;i++){_this.cities.push(data.allCities[i]);}for(var i=0;i<data.popularCities.length;i++){_this.popularCities.push(data.popularCities[i]);}$("#cityChooserHeading").focus();_this.populateCities();_this.populatePopularCities();}catch(err){_this.showError();}},error:function(){_this.showError(fullStateName);}});if(WF.Page.lang=="en"){$("#cityChooserHeading").html("Select a city in "+this.fullTitle);}else{if(WF.Page.lang=="es"){$("#cityChooserHeading").html("seleccione una ciudad en el "+this.fullTitle);}}$("#alphaFilter a").removeClass("letterFilterHighlight");$("#popularCityCol").show();$("#allCityCol").show();$("#messaging").hide();}else{this.outOfFootprint();}};CityChooser.prototype.outOfFootprint=function(){$("#messaging").html("<img src='/assets/images/locator/icn_alert_16x16.gif' alt='alert' class='oofAlert'>  "+this.fullTitle);$("#messaging").show();$("#cityChooserHeading").html(oofStates[this.chosenState]+", 0 ATMs, 0 Banks");$("#popularCityCol").hide();$("#allCityCol").hide();$(".heading").hide();$("#alphaFilterSection").hide();};CityChooser.prototype.showError=function(fullStateName){$("#messaging").html(this.errorMsg);$("#messaging").show();$("#cityChooserHeading").html(fullStateName);$("#popularCityCol").hide();$("#allCityCol").hide();$(".heading").hide();$("#alphaFilterSection").hide();};CityChooser.prototype.populateCities=function(){document.getElementById("allCities").setAttribute("role","list");var cityList=document.createElement("div");cityList.setAttribute("class","allCities");for(var i=0;i<this.cities.length;i++){this.constructListItem(this.cities[i],cityList);}this.splitList(cityList);this.manageFilterLinks(this.cities);};CityChooser.prototype.populatePopularCities=function(){var i=0,cityList=document.createElement("div"),popularCitiesLength=0;document.getElementById("popularCities").setAttribute("role","list");cityList.setAttribute("class","popularCities");document.getElementById("popularCities").innerHTML="";this.popularCities.sort();popularCitiesLength=this.popularCities.length;for(i=0;i<popularCitiesLength;i++){this.constructListItem(this.popularCities[i],cityList);}document.getElementById("popularCities").appendChild(cityList);};CityChooser.prototype.constructListItem=function(dataset,cityList){var listItem,listAnchor,anchorRef,listContent,searchAddress,_this=this,anchorRole;listItem=document.createElement("div");listItem.setAttribute("role","listitem");listAnchor=document.createElement("a");anchorRef=listAnchor.setAttribute("href","#");$(listAnchor).click(function(event){searchAddress=$(this).html()+", "+_this.chosenState;event.preventDefault();$("#mainSearchField").val(searchAddress);$("#cityChooserFlag").val("Y");$("#mainSearchlabel").hide();$("#searchForm").submit();});listContent=document.createTextNode(dataset);listAnchor.appendChild(listContent);listItem.appendChild(listAnchor);cityList.appendChild(listItem);};CityChooser.prototype.splitList=function(cityList){var i=0,partialList=null;$(cityList).find("div").each(function(){if(i%6==0){partialList=$("<div class='allCities'></div>");}partialList.append($(this));$("#allCities").append(partialList);i++;});this.manageWidth();};CityChooser.prototype.manageWidth=function(){var qtyCols=$(".allCities").length,newWidth=qtyCols*120;$("#allCities").css("width",newWidth);};CityChooser.prototype.manageFilterLinks=function(cityList){var i=0,firstLetters=[],sortedLetters=[],sortedLettersLength,firstLettersLength,cityListLength;$("#alphaFilter").html(this.theAlphaFilterNode);cityListLength=cityList.length;for(i=0;i<cityListLength;i++){firstLetters.push(cityList[i].slice(0,1));}firstLetters.sort();firstLettersLength=firstLetters.length;for(i=0;i<firstLettersLength;i++){if(firstLetters[i]!=firstLetters[i+1]){sortedLetters.push(firstLetters[i]);}}sortedLettersLength=sortedLetters.length;$("#alphaFilter li a").each(function(h){$(this).removeClass("enabled");for(i=0;i<sortedLettersLength;i++){if($(this).html().toLowerCase()==sortedLetters[i].toLowerCase()){$(this).addClass("enabled");break;}}});$("#alphaFilter li a").not(".enabled").each(function(){$(this).parent().html($(this).html());});this.addEventHandlers();};CityChooser.prototype.addAria=function(mainDiv){$(mainDiv).attr({"aria-hidden":"false"});$(mainDiv).keyup(function(event){if(event.keyCode==27){$("#closer").click();$(mainDiv).attr("aria-hidden","true");}});$("#tabReceiverBottom").focus(function(event){$("#cityChooserHeading").focus();});$("#tabReceiverTop").focus(function(){$("#allCities a").last().focus();});};CityChooser.prototype.addEventHandlers=function(){var cities=this.cities;var _this=this;$("#alphaFilterSection a").click(function(e){var firstLetter;var filteredList=document.createElement("ul");var chosenLetter=$(this).attr("id").toLowerCase();var citiesLength=cities.length;e.preventDefault();for(var i=0;i<citiesLength;i++){firstLetter=cities[i].substring(0,1).toLowerCase();if(firstLetter==chosenLetter){_this.constructListItem(cities[i],filteredList);}}$("#alphaFilter li").removeClass("letterFilterHighlight");$(this).parent().addClass("letterFilterHighlight");
$("#showAllCitiesLink").show();$("#cityByAlphabet").hide();document.getElementById("allCities").innerHTML="";_this.splitList(filteredList);});};